# Клиент-серверное приложение

Данный проект представляет собой серверное приложение, разработанное на фреймворке Qt/QML. 
Предназначенное для приема, обработки и визуализации данных от различных клиентов, а также для управления сетевыми сервесами. 
Приложение спроектировано с учетом модульности и расширяемости, разделяя логику на несколько ключевых компонентов.

1.  *ServerApp* — GUI-приложение на *Qt Quick/QML*, которое управляет подключенными клиентами и отображает их данные.
2.  *ClientApp* — консольное приложение, эмулирующее устройство.

## Технологии

*Язык: C++
*Фреймворк: Qt 6.5.2
*Компоненты Qt: Core, Network, Qml, Quick, Quick Controls
*Сборка: CMake

## Сборка и запуск

### Требования

* Qt 6.5.2 (или новее) с установленными компонентами Qt Quick
* Компилятор C++ (MSVC)
* CMake (версии 3.16 или новее)
* Qt Creator (рекомендуется)

### Сборка в Qt Creator

1.  Откройте Qt Creator.
2.  Выберите `Файл -> Открыть файл или проект...`.
3.  Найдите и выберите корневой файл `CMakeLists.txt` из папки `ClientServerApp`.
4.  Настройте комплект для сборки (убедитесь, что он поддерживает Qt Quick).
5.  Нажмите кнопку "Собрать проект" (`Ctrl+B`).

### Запуск

1.  *Запустите сервер:*
     В Qt Creator выберите `ServerApp` в качестве активного проекта и нажмите "Запустить" (`Ctrl+R`).
     Откроется окно сервера. Нажмите на кнопку с шестерёнкой "Менеджер серверов"
	 Выберите тип, порт и нажмите кнопку "Добавить" (можно сделать несколько раз для разных портов)
	 В списке с серверами нажмите кнопку "Запустить"
	 Выйдите из диалога

2.  *Запустите одного или нескольких клиентов:*
     В Qt Creator выберите `ClientApp` в качестве активного проекта и нажмите "Запустить".
     Для каждого клиента откроется консоль. Клиенты начнут подключаться к серверу.
	 
3.  *Запуск передачи*
     После подключения клиентов нажмите кнопку "Запустить всех клиентов", начнётся процесс передачи.
	 
4.  *Конфигурация*
     Для конфигурации клиента два раза щёлкните ячейке в таблице "Клиенты", откроется диалоговое окно.
	 После изменения нажмите кнопку "Применить"

### Настройка клиентов

Клиентов можно настроивать через аргументы, для этого:
1.  *Создайте ярлык клиента*

2.  *Зайдите в свойства ярлыка и в поле "Объект" добавьте нужные аргументы, например:* <br />
&nbsp;&nbsp;&nbsp;--port=1234 --clients=3<br />
где:<br />
&nbsp;&nbsp;&nbsp;--port=XXXX — порт подключения клиента.<br />
&nbsp;&nbsp;&nbsp;--clients=X — количество создаваемых клиентов.<br />

4.  *Запустите ярлык*

## Структура файлов
 <pre>
ClientServerApp/
├── readme.md                           # Общее описание проекта и инструкция по сборке
├── CMakeLists.txt                      # Корневой CMake-файл для сборки всего проекта
├── common/                         	# Общие структуры и протоколы (могут использоваться клиентом и сервером)
│   ├── protocol.h                  	# Определение протокола обмена сообщениями
│   ├── iclient.h                   	# Интерфейс клиента (может быть переиспользован из ServerApp)
│   ├── tcpclient.h                 	# Заголовочный файл реализации TCP-клиента
│   └── tcpclient.cpp                   # Реализация TCP-клиента
│
├── ClientApp/
│   ├── CMakeLists.txt                  # CMake-файл для клиентского приложения
│   ├── main.cpp                        # Точка входа клиентского приложения
│   ├── clientlogic.h                   # Заголовочный файл с логикой клиента
│   ├── clientlogic.cpp                 # Файл реализации логики клиента
│   └── clientprotocol.h            	# Общие ключи и константы клиента
│
└── ServerApp/
    ├── CMakeLists.txt                  # CMake-файл для серверного приложения
    ├── main.cpp                        # Точка входа серверного приложения (регистрирует QML, ViewModel)
    ├── qml/                            # Директория для QML-файлов
    │   ├── Main.qml                    # Главное окно приложения
    │   ├── ConfigurationDialog.qml 	# Диалог для конфигурации клиента
    │   ├── ServerManagementDialog.qml	# Диалог для управления серверами
    │   ├── UniversalTable.qml      	# Переиспользуемый компонент таблицы
    │   └── AppTheme.qml            	# Синглтон, определяющий общую тему приложения (цвета, шрифты)
    │
    ├── core/                           # Основные абстракции и утилиты
    │   ├── appenums.h                  # Перечисления для типов серверов, статусов и т.д.
    │   ├── dataprocessing.h            # Заголовочный файл для модуля обработки данных
    │   ├── dataprocessing.cpp          # Файл реализации модуля обработки данных
    │   ├── iserver.h                   # Интерфейс для различных типов серверов
    │   ├── serverfactory.h             # Фабрика для создания экземпляров серверов
    │   ├── serverworker.h              # Рабочий поток сервера (управляет серверами и обработкой данных)
    │   ├── serverworker.cpp            # Реализация рабочего потока сервера
    │   ├── sharedkeys.h                # Общие ключи для доступа к данным
    │   ├── tcpserver.h             	# Заголовочный файл реализации TCP-сервера
    │   └── tcpserver.cpp           	# Реализация TCP-сервера
    │
    └── models/                         # Модели данных для QML
        ├── tablemodel.h            	# Модель данных для списка клиентов и полученных данных
        ├── tablemodel.cpp          	# Реализация модели данных для списка клиентов и полученных данных
        ├── serverlistmodel.h           # Модель данных для списка серверов
        ├── serverlistmodel.cpp         # Реализация модели для списка серверов
        ├── serverviewmodel.h           # ViewModel для связывания C++ логики с QML
        └── serverviewmodel.cpp         # Реализация ViewModel
 </pre>

## Описание модулей проекта

### Обзор архитектуры

Проект построен по клиент-серверной архитектуре с использованием фреймворка Qt. Система разделена на три основных модуля:

- **ServerApp** — графическое приложение на Qt/QML для управления сетевыми службами
- **ClientApp** — консольное приложение, эмулирующее работу конечного устройства
- **common** — общая библиотека с классами и структурами для обеих частей

Ключевой особенностью является многопоточная обработка: вся сетевая логика вынесена в отдельный рабочий поток (`ServerWorker`), что обеспечивает отзывчивость GUI. Взаимодействие между потоками реализовано через асинхронные сигналы и слоты Qt.

### Модуль common

Фундамент для взаимодействия между клиентом и сервером:

#### Основные компоненты

- **protocol.h** — единый протокол обмена данными в формате JSON
  - Константы для типов сообщений (`Registration`, `Command`)
  - Ключи для структуры данных (`id`, `type`, `payload`)
  - Определения команд (`start`, `stop`)

- **iclient.h** — абстрактный интерфейс `IClient`
  - Базовый контракт для всех клиентских классов
  - Методы для получения ID, статуса подключения, отправки данных

- **tcpclient.h/.cpp** — реализация интерфейса `IClient` для TCP
  - Обёртка над `QTcpSocket`
  - Унифицированный доступ к TCP-функциональности

### Модуль ClientApp

Эмулирует поведение автономного устройства:

#### Структура

- **main.cpp** — точка входа приложения
  - Создание и запуск нескольких экземпляров `ClientLogic`
  - Эмуляция работы с разными серверами

- **clientlogic.h/.cpp** — основная логика клиента
  - Подключение к серверу и автоматическое переподключение
  - Отправка регистрационных запросов
  - Периодическая передача телеметрии (метрики сети, статус устройства, логи)
  - Обработка команд и конфигураций от сервера
  - Мониторинг пороговых значений и отправка критических уведомлений

- **clientprotocol.h** — константы клиента
  - Ключи для данных телеметрии (`cpuUsage`, `packetLoss`)
  - Уровни критичности логов (`INFO`, `CRITICAL`)
  - Шаблоны сообщений

### Модуль ServerApp

Основное приложение с графическим интерфейсом, состоящее из нескольких подмодулей:

#### Подмодуль core (Ядро)

Ключевые классы серверной логики:

- **iserver.h** — абстрактный интерфейс `IServer`
  - Методы `startServer`, `stopServer`, `sendToClient`
  - Сигналы `clientConnected`, `dataReceived`

- **serverfactory.h** — фабрика серверов
  - Создание экземпляров серверов (`TcpServer` и др.)
  - Поддержка различных типов протоколов

- **tcpserver.h/.cpp** — реализация `IServer` для TCP
  - Управление `QTcpServer`
  - Обработка входящих подключений
  - Создание `TcpClient` для каждого соединения

- **serverworker.h/.cpp** — рабочий поток сервера
  - Управление жизненным циклом всех серверов
  - Агрегация данных и логов от `DataProcessing`
  - Пакетная отправка данных в GUI-поток

- **dataprocessing.h/.cpp** — центральный обработчик данных
  - Парсинг JSON-сообщений от клиентов
  - Регистрация клиентов и управление их состояниями
  - Обработка входящих сообщений
  - Формирование пакетов данных для `ServerWorker`

- **appenums.h** — системные перечисления
  - Типы серверов, статусы клиентов и серверов
  - Интеграция с QML через Q_ENUM

- **sharedkeys.h** — общие ключи
  - Унифицированный доступ к данным в `QVariantMap`
  - Обеспечение совместимости между C++ и QML

#### Подмодуль models (Модели данных)

Связующее звено между C++ логикой и QML интерфейсом:

- **serverviewmodel.h/.cpp** — главная ViewModel
  - Центральный "дирижёр" GUI-стороны
  - Доступ к моделям данных из QML
  - Методы управления (`startServer`, `sortClients`)
  - Передача команд в `ServerWorker`

- **tablemodel.h/.cpp** — модели таблиц
  - Базовая модель `BaseTableModel`
  - Наследники: `ClientTableModel`, `DataTableModel`
  - Поддержка сортировки и кастомных ролей
  - Стилизация (цвета статусов)

- **serverlistmodel.h/.cpp** — модель списка серверов
  - Управление серверами (добавление, удаление)
  - Отображение статуса серверов
  - Интеграция с GUI для настройки

#### Подмодуль qml (Пользовательский интерфейс)

QML-компоненты для создания GUI:

- **Main.qml** — главное окно приложения
  - Сборка всех компонентов интерфейса
  - Общая компоновка приложения

- **Диалоги**:
  - `ConfigurationDialog.qml` — настройка клиентов
  - `ServerManagementDialog.qml` — управление серверами

- **Компоненты**:
  - `UniversalTable.qml` — переиспользуемая таблица
  - `AppTheme.qml` — глобальные стили (цвета, шрифты)

### Архитектура взаимодействия клиента и сервера
 <pre>
Серверная часть (ServerApp):
┌─────────────────────────────────────────────────────────────────┐
│                        GUI Thread                               │
│                                                                 │
│  ┌─────────────┐    ┌─────────────────┐    ┌─────────────────┐  │
│  │    QML      │◄──►│  ServerViewModel│◄──►│   TableModels   │  │
│  │             │    │                 │    │                 │  │
│  │ Main.qml    │    │ - startServer   │    │ ClientTableModel│  │
│  │ Dialogs     │    │ - sendCommand   │    │ DataTableModel  │  │
│  │ Tables      │    │ - sortClients   │    │ ServerListModel │  │
│  └─────────────┘    └─────────────────┘    └─────────────────┘  │
│                              ▲                                  │
│                              │ signals/slots                    │
│                              │                                  │
└─────────────────────────────────────────────────────────────────┘
                               │
                               │ Qt::QueuedConnection
                               ▼
┌─────────────────────────────────────────────────────────────────┐
│                       Worker Thread                             │
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐  │
│  │  ServerWorker   │◄──►│ DataProcessing  │◄──►│  IServer    │  │
│  │                 │    │                 │    │             │  │
│  │ - manageServers │    │ - processData   │    │ TcpServer   │  │
│  │ - sendBatches   │    │ - registerClient│    │ (другие...) │  │
│  │ - handleTimer   │    │ - updateStatus  │    │             │  │
│  └─────────────────┘    └─────────────────┘    └─────────────┘  │
│                                                        ▲        │
│                                                        │        │
└─────────────────────────────────────────────────────────────────┘
                                                         │
                                                         │ TCP
Клиентская часть (ClientApp):                            │
┌─────────────────────────────────────────────────────────────────┐
│                    Console Application                 │        │
│                                                        ▼        │
│  ┌─────────────────┐    ┌─────────────────┐    ┌─────────────┐  │
│  │   ClientLogic   │◄──►│   TcpClient     │◄──►│  Protocol   │  │
│  │                 │    │   (common)      │    │  (common)   │  │
│  │ - connect       │    │                 │    │             │  │
│  │ - sendData      │    │ - connectToHost │    │ JSON keys   │  │
│  │ - config        │    │ - writeData     │    │ Message     │  │
│  │ - generateData  │    │ - readData      │    │ types       │  │
│  └─────────────────┘    └─────────────────┘    └─────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
 </pre>
Ключевые интерфейсы:
- **IServer** — абстракция для всех типов серверов
- **IClient** — абстракция для клиентских соединений
- **Protocol** — единый формат JSON-сообщений
- **SharedKeys** — общие ключи для C++/QML взаимодействия

Механизмы синхронизации:
- **Сигналы и слоты Qt** для асинхронного взаимодействия между потоками
- **Qt::QueuedConnection** — между GUI и Worker потоками
- **Сетевые протоколы TCP** — между клиентом и сервером
- **JSON-сообщения** для структурированного обмена данными
- **Общие интерфейсы** из модуля `common`
- **Batch updates** — агрегация данных перед отправкой в GUI
- **Timer-based processing** — периодическая обработка данных

## Roadmap

- [x] TCP-сервер с GUI
- [x] Структурировать README
- [ ] Рефакторинг кода
- [ ] Реализовать логгер
- [ ] Добавить поддержку нескольких ServerWorker
- [ ] Реализовать логгер
- [ ] Поддержка UDP
